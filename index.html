<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>ç¯è¾°æ–‡åŒ– Â· æ™ºèƒ½è¯Šæ–­ç‰ˆ</title>
    <style>
        /* =========================================
           ğŸ¨ è§†è§‰é…ç½®
           ========================================= */
        :root {
            --bg-image: url('https://s21.ax1x.com/2025/11/25/pZAQ501.png');
            --glass-bg: rgba(0, 0, 0, 0.85); 
            --glass-border: rgba(212, 175, 55, 0.6);
            --font-title: "KaiTi", "STKaiti", serif; 
            --font-body: "Songti SC", "SimSun", serif; 
            --color-gold: #ffd700; 
            --color-red: #ff4d4d; 
            --color-green: #4caf50; 
            --color-yellow: #ffaa00; 
            --text-main: #ffffff;
        }

        body {
            margin: 0; background: var(--bg-image); background-size: cover; background-position: center; 
            color: var(--text-main); font-family: var(--font-body); height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        header {
            height: 12vh; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px double var(--color-gold); background: rgba(0,0,0,0.6); 
            padding: 0 40px;
        }
        .brand {
            font-family: var(--font-title); font-size: 5vh; color: var(--color-gold); 
            letter-spacing: 5px; font-weight: bold; text-shadow: 0 2px 5px #000; 
        }
        #clock { 
            font-family: 'Times New Roman'; font-size: 5vh; font-weight: bold; color: #ddd; 
        }

        main { flex: 1; display: flex; padding: 2vh; gap: 2vh; }

        .glass-panel {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        }

        .sidebar { flex: 25; display: flex; flex-direction: column; gap: 2vh; }
        .stat-card { padding: 2vh; text-align: center; border-bottom: 1px dashed rgba(255,255,255,0.2); }
        .stat-label { font-size: 2.5vh; color: #ccc; margin-bottom: 1vh; font-family: var(--font-title);}
        .stat-num { font-family: 'Times New Roman'; font-size: 7vh; color: var(--color-gold); font-weight: bold; line-height: 1;}
        
        .marquee-box { flex: 1; padding: 2vh; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; width: 100%; }
        .scroll-active { animation: scrollUp 40s linear infinite; }
        
        .future-item { padding: 1.5vh 0; border-bottom: 1px dashed #555; font-size: 2.2vh; display: flex; justify-content: space-between; }
        @keyframes scrollUp { 0% { top: 100%; } 100% { top: -300%; } }

        .master-grid { flex: 75; display: grid; grid-template-columns: repeat(auto-fit, minmax(22%, 1fr)); gap: 2vh; align-content: start;}
        .master-card { display: flex; flex-direction: column; align-items: center; padding: 2vh; transition: transform 0.3s; }
        
        .avatar-frame {
            width: 16vh; height: 16vh; border-radius: 50%; border: 3px solid var(--color-gold);
            padding: 3px; background: #000; margin-bottom: 2vh; box-shadow: 0 5px 20px #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        
        .master-name { font-family: var(--font-title); font-size: 3.5vh; color: var(--color-gold); margin-bottom: 2vh; letter-spacing: 3px; }
        .status-badge { margin-top: auto; padding: 1vh 0; width: 100%; text-align: center; font-size: 2.5vh; border-radius: 4px; font-family: var(--font-title); font-weight: bold; }
        .client-info-box { width: 100%; min-height: 8vh; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 1vh; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .c-name { font-size: 3vh; color: #fff; font-weight: bold; margin-bottom: 0.5vh; }
        .c-time { color: #aaa; font-family: 'Times New Roman'; font-size: 2.2vh; }

        .busy { border-color: var(--color-red); } .busy .avatar-frame { border-color: var(--color-red); } .busy .status-badge { background: var(--color-red); color: #fff; }
        .free { border-color: var(--color-green); } .free .avatar-frame { filter: grayscale(100%); opacity: 0.8; } .free .status-badge { border: 1px solid var(--color-green); color: var(--color-green); }

        /* ğŸ”´ è¯Šæ–­æŠ¥å‘Šå¼¹çª— */
        #diagnosis-box {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; font-size: 2vh;
        }
        #diagnosis-content {
            background: #222; border: 2px solid red; padding: 30px; border-radius: 10px; max-width: 80%; text-align: left;
        }
        .ok { color: #4caf50; }
        .err { color: #ff4d4d; font-weight: bold; font-size: 2.5vh; margin: 10px 0; }
        .tip { color: #aaa; margin-top: 5px; font-size: 1.8vh; }
    </style>
</head>
<body>

<div id="diagnosis-box">
    <div style="color: var(--color-gold); font-size: 4vh; margin-bottom: 20px;">ğŸ” æ­£åœ¨è¿›è¡Œæ•°æ®ä½“æ£€...</div>
    <div id="loading-text">è¿æ¥ç»´æ ¼è¡¨äº‘ç«¯...</div>
</div>

<header>
    <div class="brand">ç¯è¾°æ–‡åŒ–å‘½ç†æœåŠ¡ä¸­å¿ƒ</div>
    <div id="clock">00:00:00</div>
</header>

<main>
    <aside class="sidebar glass-panel">
        <div class="stat-card"><div class="stat-label">ä»Šæ—¥é¢„çº¦</div><div class="stat-num" id="count-total">0</div></div>
        <div class="stat-card"><div class="stat-label">ç­‰å¾…æ¥å¼•</div><div class="stat-num" id="count-wait" style="color:#fff">0</div></div>
        <div class="marquee-box">
            <div style="text-align:center; color:var(--color-gold); border-bottom:2px solid var(--color-red); padding-bottom:10px; margin-bottom:10px; font-family:var(--font-title); font-size: 2.5vh;">ğŸ“… é¢„çº¦å®å†µ</div>
            <div class="marquee-content" id="future-list"></div>
        </div>
    </aside>
    <div class="master-grid" id="master-grid"></div>
</main>

<script>
    // ==========================================
    // ğŸ”´ é…ç½®åŒº (å·²ä¸ºæ‚¨å¡«å¥½)
    // ==========================================
    const VIKA_CONFIG = {
        TOKEN: "uskRMINs8MRQZD07iTNuNnl", 
        DATASHEET_ID: "dstmgbUypiy0LbUzwF" 
    };

    // ==========================================
    // ğŸ§  æ ¸å¿ƒé€»è¾‘
    // ==========================================
    
    function showDiagnosis(html) {
        const box = document.getElementById('diagnosis-box');
        box.innerHTML = `<div id="diagnosis-content">${html}</div><button onclick="location.reload()" style="margin-top:20px; padding:10px 30px; font-size:2vh; cursor:pointer;">åˆ·æ–°é‡è¯•</button>`;
    }

    async function fetchData() {
        const url = `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.DATASHEET_ID}/records?fieldKey=name&t=${new Date().getTime()}`;
        
        try {
            const response = await fetch(url, { headers: { "Authorization": `Bearer ${VIKA_CONFIG.TOKEN}` } });
            
            if (!response.ok) {
                if(response.status === 401) showDiagnosis(`<div class="err">âŒ èº«ä»½éªŒè¯å¤±è´¥ (401)</div><div class="tip">åŸå› ï¼šToken å¤±æ•ˆæˆ–é”™è¯¯ã€‚<br>è§£å†³ï¼šè¯·å»ç»´æ ¼è¡¨é‡æ–°ç”Ÿæˆ Token å¹¶æ›¿æ¢ä»£ç ã€‚</div>`);
                else if(response.status === 404) showDiagnosis(`<div class="err">âŒ æ‰¾ä¸åˆ°è¡¨æ ¼ (404)</div><div class="tip">åŸå› ï¼šè¡¨æ ¼ ID (dst...) å¡«é”™äº†ã€‚<br>è§£å†³ï¼šè¯·æ£€æŸ¥æµè§ˆå™¨åœ°å€æ çš„ dst å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚</div>`);
                else showDiagnosis(`<div class="err">âŒ è¿æ¥å¤±è´¥: ${response.status}</div>`);
                return;
            }

            const json = await response.json();
            
            if (json.code === 200) {
                const records = json.data.records;
                
                // ğŸ” æ·±åº¦è¯Šæ–­ï¼šæ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©º
                if (records.length === 0) {
                    showDiagnosis(`<div class="err">âš ï¸ è¿æ¥æˆåŠŸï¼Œä½†ç»´æ ¼è¡¨æ˜¯ç©ºçš„ï¼</div><div class="tip">è§£å†³ï¼šè¯·å»ç»´æ ¼è¡¨é‡Œæ·»åŠ è‡³å°‘ä¸€è¡Œæ•°æ®ï¼ˆå¤§å¸ˆã€æ—¶é—´ç­‰ï¼‰ã€‚</div>`);
                    return;
                }

                // ğŸ” æ·±åº¦è¯Šæ–­ï¼šæ£€æŸ¥åˆ—å
                const firstRow = records[0].fields;
                const keys = Object.keys(firstRow);
                
                // æ£€æŸ¥å…³é”®åˆ—æ˜¯å¦å­˜åœ¨
                if (!keys.includes("å¤§å¸ˆ")) {
                    showDiagnosis(`
                        <div class="err">âŒ ä¸¥é‡é”™è¯¯ï¼šæ²¡æ‰¾åˆ°ã€å¤§å¸ˆã€‘åˆ—ï¼</div>
                        <div class="tip">
                            <strong>ä»£ç åªèƒ½è¯»å–å«â€œå¤§å¸ˆâ€çš„åˆ—ï¼Œä½†æ‚¨è¡¨æ ¼é‡Œçš„åˆ—åæ˜¯ï¼š</strong><br>
                            [ ${keys.join(" , ")} ]
                            <br><br>
                            <strong>è§£å†³æ–¹æ³•ï¼š</strong><br>
                            è¯·å›åˆ°ç»´æ ¼è¡¨ï¼ŒåŒå‡»é‚£ä¸ªå¡«åå­—çš„åˆ—å¤´ï¼ŒæŠŠå®ƒæ”¹åä¸º <strong>å¤§å¸ˆ</strong> (ä¸¤ä¸ªå­—ï¼Œä¸è¦ç©ºæ ¼)ã€‚
                        </div>
                    `);
                    return;
                }

                // ä¸€åˆ‡æ­£å¸¸ï¼Œéšè—è¯Šæ–­ï¼Œæ˜¾ç¤ºç•Œé¢
                document.getElementById('diagnosis-box').style.display = 'none';
                processData(records);

            } else {
                showDiagnosis(`<div class="err">âŒ API æŠ¥é”™: ${json.message}</div>`);
            }
        } catch (err) {
            showDiagnosis(`<div class="err">âŒ ç½‘ç»œæ— æ³•è¿æ¥</div><div class="tip">è¯·æ£€æŸ¥ç”µè„‘/ç”µè§†æ˜¯å¦è¿ç½‘ã€‚<br>é”™è¯¯ä¿¡æ¯: ${err.message}</div>`);
        }
    }

    function processData(records) {
        const mastersMap = {};
        const appointments = [];

        records.forEach(r => {
            const f = r.fields;
            const name = f['å¤§å¸ˆ'];
            if (!name) return;

            // A. æå–å¤´åƒ
            let avatarUrl = "";
            const rawAvatar = f['å¤´åƒ'];
            if (rawAvatar) {
                if (Array.isArray(rawAvatar) && rawAvatar.length > 0) avatarUrl = rawAvatar[0].url;
                else if (typeof rawAvatar === 'string') avatarUrl = rawAvatar;
            }
            
            if (!mastersMap[name] || (avatarUrl && !mastersMap[name].img)) {
                mastersMap[name] = { name: name, img: avatarUrl || "" };
            }

            // B. æå–é¢„çº¦
            if (f['æ—¥æœŸ'] && f['æ—¶é—´']) {
                appointments.push({
                    master: name,
