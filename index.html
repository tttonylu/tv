<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />
    <title>ç¯è¾°æ–‡åŒ– Â· æœ€ç»ˆè¯Šæ–­ç‰ˆ</title>
    <style>
        /* è§†è§‰é£æ ¼ä¿æŒä¸å˜ */
        :root {
            --bg-image: url('https://s21.ax1x.com/2025/11/25/pZAQ501.png');
            --glass-bg: rgba(0, 0, 0, 0.75); --glass-border: rgba(212, 175, 55, 0.6);
            --font-title: "KaiTi", "STKaiti", "BiauKai", serif; --font-body: "Songti SC", "SimSun", serif; 
            --color-gold: #ffd700; --color-red: #ff4d4d; --color-green: #4caf50; --text-main: #ffffff;
        }
        body { margin: 0; background: var(--bg-image); background-size: cover; background-position: center; color: var(--text-main); font-family: var(--font-body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        header { height: 12vh; display: flex; justify-content: center; align-items: center; border-bottom: 3px double var(--color-gold); background: rgba(0,0,0,0.6); position: relative; }
        .brand { font-family: var(--font-title); font-size: 5vh; color: var(--color-gold); letter-spacing: 5px; font-weight: bold; text-shadow: 0 2px 5px #000; }
        .date-info { position: absolute; right: 30px; text-align: right; color: #ddd; font-size: 2.5vh; }
        main { flex: 1; display: flex; padding: 2vh; gap: 2vh; }
        .glass-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .sidebar { flex: 25; display: flex; flex-direction: column; gap: 2vh; }
        .stat-card { padding: 2vh; text-align: center; border-bottom: 1px dashed rgba(255,255,255,0.2); }
        .stat-label { font-size: 2.5vh; color: #ccc; margin-bottom: 1vh; font-family: var(--font-title);}
        .stat-num { font-family: 'Times New Roman'; font-size: 7vh; color: var(--color-gold); font-weight: bold; line-height: 1;}
        .marquee-box { flex: 1; padding: 2vh; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; width: 100%; animation: scrollUp 25s linear infinite; }
        .future-item { padding: 1.5vh 0; border-bottom: 1px dashed #555; font-size: 2.2vh; display: flex; justify-content: space-between; }
        @keyframes scrollUp { 0% { top: 100%; } 100% { top: -200%; } }
        .master-grid { flex: 75; display: grid; grid-template-columns: repeat(4, 1fr); gap: 2vh; }
        .master-card { display: flex; flex-direction: column; align-items: center; padding: 2vh; transition: transform 0.3s; }
        .avatar-frame { width: 16vh; height: 16vh; border-radius: 50%; border: 3px solid var(--color-gold); padding: 3px; background: #000; margin-bottom: 2vh; box-shadow: 0 5px 20px #000; overflow: hidden; display: flex; justify-content: center; align-items: center; position: relative; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .master-name { font-family: var(--font-title); font-size: 3.5vh; color: var(--color-gold); margin-bottom: 2vh; letter-spacing: 3px; }
        .status-badge { margin-top: auto; padding: 1vh 0; width: 100%; text-align: center; font-size: 2.5vh; border-radius: 4px; font-family: var(--font-title); font-weight: bold; }
        .client-info-box { width: 100%; min-height: 8vh; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 1vh; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .c-name { font-size: 3vh; color: #fff; font-weight: bold; margin-bottom: 0.5vh; }
        .c-time { color: #aaa; font-family: 'Times New Roman'; font-size: 2.2vh; }
        .busy { border-color: var(--color-red); } .busy .avatar-frame { border-color: var(--color-red); } .busy .status-badge { background: var(--color-red); color: #fff; }
        .free { border-color: var(--color-green); } .free .avatar-frame { filter: grayscale(100%); opacity: 0.8; } .free .status-badge { border: 1px solid var(--color-green); color: var(--color-green); }
        
        /* è¯Šæ–­åŠ è½½æ¡æ ·å¼ */
        #loader { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:#000; z-index:9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: var(--color-gold); font-size: 3vh; text-align: center;
        }
        #error-msg { color: #ff4d4d; margin-top: 20px; font-size: 2vh; max-width: 80%; }
    </style>
</head>
<body>

<div id="loader">
    <div>æ­£åœ¨è¿æ¥ç»´æ ¼è¡¨äº‘ç«¯...</div>
    <div id="error-msg"></div>
</div>

<header>
    <div class="brand">ç¯è¾°æ–‡åŒ–å‘½ç†æœåŠ¡ä¸­å¿ƒ</div>
    <div class="date-info">
        <div id="lunar" style="font-family: var(--font-title); font-size: 1.2em;">æ•°æ®åŒæ­¥ä¸­</div>
        <div id="clock" style="font-family: 'Times New Roman'; font-size: 1.5em; margin-top: 5px;">00:00:00</div>
    </div>
</header>

<main>
    <aside class="sidebar glass-panel">
        <div class="stat-card"><div class="stat-label">ä»Šæ—¥ç»“ç¼˜</div><div class="stat-num" id="count-total">0</div></div>
        <div class="stat-card"><div class="stat-label">ç­‰å¾…æ¥å¼•</div><div class="stat-num" id="count-wait" style="color:#fff">0</div></div>
        <div class="marquee-box">
            <div style="text-align:center; color:var(--color-gold); border-bottom:2px solid var(--color-red); padding-bottom:10px; margin-bottom:10px; font-family:var(--font-title); font-size: 2.5vh;">ğŸ“… æœˆåº¦æ’æœŸæ¦‚è§ˆ</div>
            <div class="marquee-content" id="future-list"></div>
        </div>
    </aside>
    <div class="master-grid" id="master-grid"></div>
</main>

<script>
    // ==========================================
    // ğŸ”´ é…ç½®åŒº (è¯·å†æ¬¡ä»”ç»†æ ¸å¯¹)
    // ==========================================
    const VIKA_CONFIG = {
        TOKEN: "uskRMINs8MRQZD07iTNuNnl",  // åŠ¡å¿…ç¡®è®¤ Token æ­£ç¡®
        DATASHEET_ID: "dstmgbUypiy0LbUzwF" // åŠ¡å¿…ç¡®è®¤ ID æ­£ç¡®
    };

    // ==========================================
    // ğŸ§  æ ¸å¿ƒé€»è¾‘
    // ==========================================
    async function fetchData() {
        // ä½¿ç”¨æ›´å®‰å…¨çš„ URL å†™æ³•ï¼Œå»é™¤å¯èƒ½å¯¼è‡´æŠ¥é”™çš„æ—¶é—´æˆ³å‚æ•°
        // æ”¹ç”¨ cache: 'no-store' æ¥å¼ºåˆ¶åˆ·æ–°
        const url = `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.DATASHEET_ID}/records?fieldKey=name`;
        
        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: { 
                    "Authorization": `Bearer ${VIKA_CONFIG.TOKEN}`
                },
                cache: 'no-store' // å…³é”®ä¿®å¤ï¼šå‘Šè¯‰æµè§ˆå™¨ä¸è¦ç¼“å­˜ï¼Œå¼ºåˆ¶æ‹‰æ–°æ•°æ®
            });

            if (response.ok) {
                const json = await response.json();
                if (json.code === 200) {
                    processData(json.data.records);
                    document.getElementById('loader').style.display = 'none'; // æˆåŠŸåˆ™éšè—
                    const timeStr = new Date().toLocaleTimeString('zh-CN', {hour12:false});
                    document.getElementById('lunar').innerText = `ä¹™å·³å¹´ Â· é¡ºé¢‚æ—¶ç¥º (åŒæ­¥: ${timeStr})`;
                } else {
                    // API è¿”å›é”™è¯¯
                    showError(`ç»´æ ¼è¡¨æŠ¥é”™: ${json.message} (ä»£ç : ${json.code})`);
                }
            } else {
                // ç½‘ç»œå±‚é¢çš„é”™è¯¯ (å¦‚ 404, 401, 500)
                showError(`è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}\nè¯·æ£€æŸ¥ Token æˆ–è¡¨æ ¼ ID`);
            }
        } catch (err) {
            // æ–­ç½‘æˆ–å…¶ä»–ä¸¥é‡é”™è¯¯
            console.error(err);
            showError(`ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥æœåŠ¡å™¨ã€‚\nè¯·æ£€æŸ¥ç”µè§†ç½‘ç»œæ˜¯å¦æ­£å¸¸ã€‚\n${err.message}`);
        }
    }

    function showError(msg) {
        const el = document.getElementById('error-msg');
        el.innerText = msg;
        el.style.display = 'block';
        // ä¸éšè— loaderï¼Œè®©ç”¨æˆ·çœ‹åˆ°é”™è¯¯
    }

    function processData(records) {
        const mastersMap = {};
        const appointments = [];

        records.forEach(r => {
            const f = r.fields;
            if (!f['å¤§å¸ˆ']) return;

            let avatarUrl = "";
            const rawAvatar = f['å¤´åƒ'];
            if (rawAvatar) {
                if (Array.isArray(rawAvatar) && rawAvatar.length > 0) avatarUrl = rawAvatar[0].url;
                else if (typeof rawAvatar === 'string') avatarUrl = rawAvatar;
            }

            if (!mastersMap[f['å¤§å¸ˆ']] || (avatarUrl && !mastersMap[f['å¤§å¸ˆ']].img)) {
                mastersMap[f['å¤§å¸ˆ']] = { name: f['å¤§å¸ˆ'], img: avatarUrl };
            }

            if (f['æ—¥æœŸ'] && f['æ—¶é—´']) {
                appointments.push({
                    master: f['å¤§å¸ˆ'],
                    client: f['å®¢æˆ·'] || "ç¥ç§˜ç¼˜ä¸»",
                    date: f['æ—¥æœŸ'],
                    start: f['æ—¶é—´'],
                    duration: f['æ—¶é•¿'] || 60
                });
            }
        });

        renderScreen(Object.values(mastersMap), appointments);
    }

    function renderScreen(masters, appointments) {
        const grid = document.getElementById('master-grid');
        grid.innerHTML = '';
        const now = new Date();
        const curMins = now.getHours() * 60 + now.getMinutes();
        const todayStr = getTodayStr();

        masters.forEach(m => {
            const myAppts = appointments.filter(a => a.master === m.name && a.date === todayStr);
            let status = 'free', active = null, next = null;

            myAppts.forEach(a => {
                const s = getMins(a.start), e = s + parseInt(a.duration);
                if (curMins >= s && curMins < e) { status = 'busy'; active = {...a, end: formatTime(e)}; }
                else if (curMins < s) { if(!next || s < getMins(next.start)) next = a; }
            });

            // çº¯å›¾ç‰‡å¤´åƒ
            let avatarHtml = '';
            if (m.img) {
                avatarHtml = `<img src="${m.img}" class="avatar-img" onerror="this.style.display='none'">`;
            } else {
                avatarHtml = `<div style="width:100%;height:100%;background:#000;"></div>`;
            }

            let infoHtml = status === 'busy' 
                ? `<div class="client-info-box"><div class="c-name">${active.client}</div><div class="c-time">${active.start} - ${active.end}</div></div><div class="status-badge">æ­£åœ¨æ¨æ¼”</div>`
                : `<div class="client-info-box"><div style="color:#aaa;">${next?'ä¸‹ä¸€ä½:'+next.start:'ä»Šæ—¥ç©ºé—²'}</div><div style="color:#8
