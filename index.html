<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>灯辰文化 - 咨询看板</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">

    <style>
        :root {
            /* === 配色方案：新中式玄学风 === */
            --bg-overlay: rgba(0, 0, 0, 0.65); /* 背景遮罩减弱，更通透 */
            --panel-bg: rgba(20, 20, 20, 0.5); /* 极高透明度面板 */
            --card-bg: rgba(30, 30, 30, 0.55);
            
            --text-gold: #eebb66; /* 赤金 */
            --text-white: #f2f2f2;
            --text-dim: #a0a0a0;
            
            --border-gold: #b89348;
            
            /* 状态色 - 中国传统色 */
            --color-busy: #b71c1c;  /* 丹红 (忙碌) */
            --color-free: #2e7d32;  /* 竹青 (空闲) */
            --color-prep: #7b1fa2;  /* 紫气 (恭候/准备) */

            --font-main: 'Noto Serif SC', serif;
            --font-art: 'ZCOOL XiaoWei', serif; /* 艺术字体 */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: url('https://s21.ax1x.com/2025/11/25/pZAQ501.png') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-white);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            position: relative;
            /* 竖屏布局核心 */
            display: flex;
            flex-direction: column; 
        }

        /* 全局遮罩 */
        body::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-overlay); z-index: -1;
        }

        /* === 装饰纹样 (四角边框) === */
        .corner-decor {
            position: fixed; width: 50px; height: 50px;
            border: 3px double var(--border-gold);
            z-index: 0; pointer-events: none; opacity: 0.6;
        }
        .c-tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .c-tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .c-bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .c-br { bottom: 20px; right: 20px; border-left: none; border-top: none; }

        /* === 顶部区域：Logo + 时间 === */
        .header {
            height: 15vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 3rem;
            border-bottom: 1px solid rgba(184, 147, 72, 0.3);
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 10;
        }

        .brand-box {
            display: flex;
            flex-direction: column;
        }
        .brand-name {
            font-family: var(--font-art);
            font-size: 3.5rem;
            color: var(--text-gold);
            letter-spacing: 0.2rem;
            text-shadow: 0 0 10px rgba(238, 187, 102, 0.4);
        }
        .brand-sub {
            font-size: 1rem;
            color: var(--text-dim);
            letter-spacing: 0.4rem;
            margin-top: 0.5rem;
            text-transform: uppercase; /* 虽不显示英文，但保持样式 */
        }

        .clock-box {
            text-align: right;
            border-left: 2px solid var(--border-gold);
            padding-left: 1.5rem;
        }
        .clock-time {
            font-size: 3rem;
            font-weight: bold;
            font-family: 'Courier New', serif; /* 数字用等宽衬线体 */
            color: var(--text-white);
        }
        .clock-date {
            font-size: 1.2rem;
            color: var(--text-gold);
            margin-top: 0.5rem;
        }

        /* === 中部区域：数据概览 + 滚动通告 === */
        .info-bar {
            height: 12vh;
            display: flex;
            border-bottom: 1px solid rgba(184, 147, 72, 0.3);
            background: var(--panel-bg);
            backdrop-filter: blur(5px); /* 磨砂玻璃感 */
        }

        .stats-area {
            width: 30%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-right: 1px solid rgba(184, 147, 72, 0.3);
        }
        .stat-item { text-align: center; }
        .stat-val { font-size: 2rem; color: var(--text-gold); font-family: var(--font-art); }
        .stat-key { font-size: 0.9rem; color: var(--text-dim); }

        .marquee-area {
            width: 70%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 2rem;
        }
        .marquee-label {
            white-space: nowrap;
            color: var(--text-gold);
            font-weight: bold;
            margin-right: 1.5rem;
            border: 1px solid var(--border-gold);
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .marquee-viewport {
            flex-grow: 1;
            height: 100%;
            position: relative;
            overflow: hidden;
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        .marquee-track {
            display: flex;
            position: absolute;
            height: 100%;
            align-items: center;
            white-space: nowrap;
            /* 动画在JS中动态注入 */
        }
        .mq-item {
            margin-right: 3rem;
            font-size: 1.2rem;
            color: var(--text-white);
        }
        .mq-time { color: var(--text-gold); margin-right: 0.5rem; }

        /* === 下部区域：大师列表 (竖向堆叠) === */
        .content-area {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: hidden; /* 防止主页面滚动，让内部卡片自适应 */
            display: flex;
            flex-direction: column;
        }

        .master-list {
            display: flex;
            flex-direction: column; /* 强制竖列 */
            gap: 1.5rem;
            height: 100%;
            /* 如果卡片太多，自动缩放或滚动，这里做成Grid单列适应 */
            overflow-y: auto;
        }
        
        /* 隐藏滚动条 */
        .master-list::-webkit-scrollbar { display: none; }

        .master-card {
            display: flex;
            background: var(--card-bg);
            border: 1px solid rgba(184, 147, 72, 0.3);
            border-radius: 4px;
            overflow: hidden;
            min-height: 140px; /* 竖条状卡片高度 */
            transition: all 0.5s ease;
            position: relative;
        }

        /* 侧边状态条 */
        .status-indicator {
            width: 12px;
            height: 100%;
        }

        .card-inner {
            flex-grow: 1;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            justify-content: space-between;
        }

        .master-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .avatar-box {
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 2px solid var(--border-gold);
            padding: 3px;
            position: relative;
        }
        .avatar-img {
            width: 100%; height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .text-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .m-name {
            font-size: 2.2rem;
            color: var(--text-white);
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .m-client {
            font-size: 1.1rem;
            color: var(--text-dim);
            font-style: italic;
        }

        .status-badge {
            font-size: 1.8rem;
            font-family: var(--font-art);
            font-weight: bold;
            letter-spacing: 0.2rem;
            padding: 0.5rem 1.5rem;
            border: 1px solid currentColor;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            min-width: 160px;
            text-align: center;
        }

        /* === 状态特定样式 === */
        /* 1. 忙碌 */
        .s-busy .status-indicator { background: var(--color-busy); box-shadow: 2px 0 15px var(--color-busy); }
        .s-busy .status-badge { color: var(--color-busy); border-color: var(--color-busy); text-shadow: 0 0 10px rgba(183, 28, 28, 0.6); }
        .s-busy { border-color: rgba(183, 28, 28, 0.4); }

        /* 2. 空闲 */
        .s-free .status-indicator { background: var(--color-free); box-shadow: 2px 0 15px var(--color-free); }
        .s-free .status-badge { color: var(--color-free); border-color: var(--color-free); text-shadow: 0 0 10px rgba(46, 125, 50, 0.6); }
        .s-free { border-color: rgba(46, 125, 50, 0.4); }

        /* 3. 恭候 (10分钟前) */
        .s-prep .status-indicator { background: var(--color-prep); box-shadow: 2px 0 15px var(--color-prep); }
        .s-prep .status-badge { color: #d05ce3; border-color: #d05ce3; text-shadow: 0 0 10px rgba(123, 31, 162, 0.6); }
        .s-prep { border-color: rgba(123, 31, 162, 0.4); }

        /* === 错误弹窗 === */
        #error-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; color: var(--color-busy);
        }
        #error-overlay h2 { font-size: 2rem; border-bottom: 1px solid; margin-bottom: 1rem; }

        @keyframes marqueeScroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

    </style>
</head>
<body>

    <div class="corner-decor c-tl"></div>
    <div class="corner-decor c-tr"></div>
    <div class="corner-decor c-bl"></div>
    <div class="corner-decor c-br"></div>

    <div id="error-overlay">
        <h2>连接中断</h2>
        <p id="error-message">正在初始化...</p>
    </div>

    <header class="header">
        <div class="brand-box">
            <div class="brand-name">灯辰文化</div>
            <div class="brand-sub">Metaphysics Consulting</div>
        </div>
        <div class="clock-box">
            <div class="clock-time" id="clock-time">00:00:00</div>
            <div class="clock-date" id="clock-date">载入中...</div>
        </div>
    </header>

    <div class="info-bar">
        <div class="stats-area">
            <div class="stat-item">
                <div class="stat-val" id="count-today">0</div>
                <div class="stat-key">今日预约</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="count-waiting">0</div>
                <div class="stat-key">当前候客</div>
            </div>
        </div>
        <div class="marquee-area">
            <div class="marquee-label">近期预约</div>
            <div class="marquee-viewport">
                <div class="marquee-track" id="marquee-track">
                    </div>
            </div>
        </div>
    </div>

    <div class="content-area">
        <div class="master-list" id="master-list">
            </div>
    </div>

    <script>
        // ================= 配置区域 =================
        const VIKA_API_TOKEN = 'YOUR_VIKA_API_TOKEN_HERE'; 
        const VIKA_DATASHEET_ID = 'YOUR_DATASHEET_ID_HERE'; 
        // ============================================

        const REFRESH_INTERVAL = 30000; 

        // DOM Elements
        const errorOverlay = document.getElementById('error-overlay');
        const errorMsg = document.getElementById('error-message');
        const masterListEl = document.getElementById('master-list');
        const marqueeTrack = document.getElementById('marquee-track');
        const countTodayEl = document.getElementById('count-today');
        const countWaitingEl = document.getElementById('count-waiting');
        const clockTimeEl = document.getElementById('clock-time');
        const clockDateEl = document.getElementById('clock-date');

        // Init
        init();
        startClock();

        function startClock() {
            setInterval(() => {
                const now = new Date();
                // 24小时制时间
                const timeStr = now.toLocaleTimeString('en-GB', { hour12: false }); 
                // 日期：yyyy年MM月dd日 星期X
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                const dateStr = now.toLocaleDateString('zh-CN', options);
                
                clockTimeEl.textContent = timeStr;
                clockDateEl.textContent = dateStr;
            }, 1000);
        }

        async function init() {
            if (VIKA_API_TOKEN.includes('YOUR_')) {
                showError('配置错误：请修改 HTML 文件中的 API Token');
                return;
            }
            await fetchDataAndRender();
            setInterval(fetchDataAndRender, REFRESH_INTERVAL);
        }

        async function fetchDataAndRender() {
            try {
                const url = `https://api.vika.cn/fusion/v1/datasheets/${VIKA_DATASHEET_ID}/records?fieldKey=name`;
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${VIKA_API_TOKEN}` } });
                
                if (!response.ok) throw new Error('网络请求失败');
                const json = await response.json();
                if (json.code !== 200) throw new Error(json.message);

                errorOverlay.style.display = 'none';
                processData(json.data.records);

            } catch (err) {
                console.error(err);
                showError(err.message);
            }
        }

        function processData(records) {
            const now = new Date();
            const mastersMap = {}; 
            const futureAppointments = []; 
            let todayCount = 0; 

            records.forEach(record => {
                const fields = record.fields;
                if (!fields['大师']) return;
                const masterName = fields['大师'];
                
                // 日期解析 (兼容性修复)
                let rawDate = fields['日期'];
                let rawTime = fields['时间'];
                if (!rawDate || !rawTime) return;

                let dateStr = '';
                if (typeof rawDate === 'number') {
                    const d = new Date(rawDate);
                    dateStr = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
                } else {
                    dateStr = String(rawDate).replace(/\//g, '-');
                }
                
                const startTime = new Date(`${dateStr}T${rawTime}:00`);
                if (isNaN(startTime.getTime())) return;

                const duration = fields['时长'] || 60; 
                const endTime = new Date(startTime.getTime() + duration * 60000);
                const intervention = fields['状态干预']; // 强制忙碌/强制空闲/取消

                const appt = {
                    client: fields['客户'] || '善信',
                    startTime: startTime,
                    endTime: endTime,
                    intervention: intervention,
                    master: masterName
                };

                // 统计
                const isToday = (startTime.getDate() === now.getDate() && startTime.getMonth() === now.getMonth());
                if (isToday) todayCount++;
                if (startTime > now && isToday && intervention !== '取消') {
                    futureAppointments.push(appt);
                }

                // 分组
                if (!mastersMap[masterName]) {
                    let photo = null;
                    if (fields['头像'] && fields['头像'][0]) photo = fields['头像'][0].url;
                    mastersMap[masterName] = { name: masterName, photo: photo, appointments: [] };
                }
                mastersMap[masterName].appointments.push(appt);
            });

            renderMarquee(futureAppointments, todayCount);
            renderMasterList(mastersMap);
        }

        function renderMarquee(list, total) {
            list.sort((a, b) => a.startTime - b.startTime);
            countTodayEl.textContent = total;
            countWaitingEl.textContent = list.length;

            marqueeTrack.innerHTML = '';
            if (list.length === 0) {
                marqueeTrack.innerHTML = '<div class="mq-item" style="color:#aaa;">今日后续暂无预约</div>';
                return;
            }

            list.forEach(item => {
                const time = item.startTime.toTimeString().substring(0, 5);
                const div = document.createElement('div');
                div.className = 'mq-item';
                div.innerHTML = `<span class="mq-time">${time}</span> ${item.master} 预约：${item.client}`;
                marqueeTrack.appendChild(div);
            });

            // 动态设置滚动动画
            // 滚动时间 = 宽度 / 速度 (px/s)
            const width = marqueeTrack.scrollWidth;
            const containerWidth = marqueeTrack.parentElement.clientWidth;
            
            if (width > containerWidth) {
                const duration = width / 50; // 50px每秒
                marqueeTrack.style.animation = `marqueeScroll ${duration}s linear infinite`;
            } else {
                marqueeTrack.style.animation = 'none';
            }
        }

        function renderMasterList(map) {
            masterListEl.innerHTML = '';
            const now = new Date();
            const keys = Object.keys(map);

            if (keys.length === 0) {
                masterListEl.innerHTML = '<div style="text-align:center; padding:5rem; color:#aaa;">暂无大师数据</div>';
                return;
            }

            keys.forEach(key => {
                const m = map[key];
                let status = 's-free';
                let text = '空闲 · 纳客';
                let clientText = '当前无咨客';
                
                // 逻辑检查
                for (let appt of m.appointments) {
                    if (appt.intervention === '取消') continue;

                    // 时间判定
                    const isBusyTime = now >= appt.startTime && now < appt.endTime;
                    // 10分钟提醒 (修改了这里的逻辑)
                    const prepTimeStart = new Date(appt.startTime.getTime() - 10 * 60000); 
                    const isPrepTime = now >= prepTimeStart && now < appt.startTime;

                    // 优先级 1: 强制干预
                    if ((isBusyTime || isPrepTime) && appt.intervention === '强制忙碌') {
                         status = 's-busy'; text = '咨询中 · 勿扰'; clientText = `咨客：${appt.client} (特约)`;
                         break;
                    }
                    if ((isBusyTime || isPrepTime) && appt.intervention === '强制空闲') {
                        continue; 
                    }

                    // 优先级 2: 正常时间
                    if (isBusyTime) {
                        status = 's-busy'; text = '咨询中 · 勿扰'; clientText = `咨客：${appt.client}`;
                        break;
                    } else if (isPrepTime && status !== 's-busy') {
                        status = 's-prep'; text = '恭候 · 待启'; clientText = `下位咨客：${appt.client}`;
                        // 不 break，继续找是否有冲突的 busy
                    }
                }

                const card = document.createElement('div');
                card.className = `master-card ${status}`;
                const photoUrl = m.photo || 'https://via.placeholder.com/150/333/d4af37?text=Master';

                card.innerHTML = `
                    <div class="status-indicator"></div>
                    <div class="card-inner">
                        <div class="master-info">
                            <div class="avatar-box">
                                <img src="${photoUrl}" class="avatar-img">
                            </div>
                            <div class="text-info">
                                <div class="m-name">${m.name}</div>
                                <div class="m-client">${clientText}</div>
                            </div>
                        </div>
                        <div class="status-badge">${text}</div>
                    </div>
                `;
                masterListEl.appendChild(card);
            });
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorOverlay.style.display = 'flex';
        }
    </script>
</body>
</html>
