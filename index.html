<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯è¾°æ–‡åŒ– Â· ç”µè§†ä¸“ç”¨ç‰ˆ</title>
    <style>
        /* =========================================
           ğŸ¨ è§†è§‰é£æ ¼ï¼šç”µè§†ä¸“ç”¨ä¼˜åŒ– (é«˜æ€§èƒ½ã€å¤§å­—å·)
           ========================================= */
        :root {
            /* æ‚¨æä¾›çš„èƒŒæ™¯å›¾ */
            --bg-image: url('https://s21.ax1x.com/2025/11/25/pZAQ501.png');
            
            /* åŠ æ·±èƒŒæ™¯è‰²ï¼Œæå‡æ–‡å­—å¯¹æ¯”åº¦ */
            --glass-bg: rgba(0, 0, 0, 0.75); 
            --glass-border: rgba(212, 175, 55, 0.6);
            
            --font-title: "KaiTi", "STKaiti", "BiauKai", serif; 
            --font-body: "Songti SC", "SimSun", serif; 
            
            --color-gold: #ffd700; /* æ›´äº®çš„é‡‘è‰² */
            --color-red: #ff4d4d;
            --color-green: #4caf50;
            --text-main: #ffffff;
        }

        body {
            margin: 0; 
            background: var(--bg-image); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            color: var(--text-main); 
            font-family: var(--font-body); 
            height: 100vh; 
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }

        /* é¡¶éƒ¨ - å¢åŠ é«˜åº¦å æ¯” */
        header {
            height: 12vh; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            border-bottom: 3px double var(--color-gold); 
            background: rgba(0,0,0,0.6); 
            position: relative;
        }
        .brand {
            font-family: var(--font-title); 
            font-size: 5vh; /* å¤§å­—å· */
            color: var(--color-gold); 
            letter-spacing: 5px; 
            font-weight: bold;
            text-shadow: 0 2px 5px #000; 
        }
        .date-info { 
            position: absolute; 
            right: 30px; 
            text-align: right; 
            color: #ddd; 
            font-size: 2.5vh;
        }

        main { flex: 1; display: flex; padding: 2vh; gap: 2vh; }

        /* é¢æ¿é€šç”¨ - ç§»é™¤æ¨¡ç³Šæ»¤é•œæå‡æ€§èƒ½ */
        .glass-panel {
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        }

        /* å·¦ä¾§æ•°æ®æ  (å æ¯” 25%) */
        .sidebar { flex: 25; display: flex; flex-direction: column; gap: 2vh; }
        
        .stat-card { padding: 2vh; text-align: center; border-bottom: 1px dashed rgba(255,255,255,0.2); }
        .stat-label { font-size: 2.5vh; color: #ccc; margin-bottom: 1vh; font-family: var(--font-title);}
        .stat-num { font-family: 'Times New Roman'; font-size: 7vh; color: var(--color-gold); font-weight: bold; line-height: 1;}
        
        .marquee-box { flex: 1; padding: 2vh; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; width: 100%; animation: scrollUp 25s linear infinite; }
        .future-item { 
            padding: 1.5vh 0; 
            border-bottom: 1px dashed #555; 
            font-size: 2.2vh; 
            display: flex; justify-content: space-between; 
        }
        @keyframes scrollUp { 0% { top: 100%; } 100% { top: -200%; } }

        /* å³ä¾§å¤§å¸ˆé˜µåˆ— (å æ¯” 75%) */
        .master-grid { 
            flex: 75; 
            display: grid; 
            /* ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ä¸€è¡Œ 4 åˆ— */
            grid-template-columns: repeat(4, 1fr); 
            gap: 2vh; 
        }
        
        .master-card { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 2vh; 
            transition: transform 0.3s; 
        }
        
        /* å¤´åƒæ¡† - è‡ªé€‚åº”é«˜åº¦ */
        .avatar-frame {
            width: 16vh; height: 16vh; 
            border-radius: 50%; 
            border: 3px solid var(--color-gold);
            padding: 3px; background: #000; margin-bottom: 2vh; 
            box-shadow: 0 5px 20px #000; overflow: hidden;
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        
        .master-name { font-family: var(--font-title); font-size: 3.5vh; color: var(--color-gold); margin-bottom: 2vh; letter-spacing: 3px; }
        
        .status-badge { 
            margin-top: auto; padding: 1vh 0; width: 100%; text-align: center; 
            font-size: 2.5vh; border-radius: 4px; font-family: var(--font-title); font-weight: bold;
        }

        .client-info-box { 
            width: 100%;
            min-height: 8vh; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            margin-bottom: 1vh; background: rgba(255,255,255,0.05); border-radius: 4px;
        }
        .c-name { font-size: 3vh; color: #fff; font-weight: bold; margin-bottom: 0.5vh; }
        .c-time { color: #aaa; font-family: 'Times New Roman'; font-size: 2.2vh; }

        /* çŠ¶æ€å˜è‰² */
        .busy { border-color: var(--color-red); box-shadow: 0 0 20px rgba(192, 44, 56, 0.4); }
        .busy .avatar-frame { border-color: var(--color-red); }
        .busy .status-badge { background: var(--color-red); color: #fff; }

        .free { border-color: var(--color-green); }
        .free .avatar-frame { filter: grayscale(100%); opacity: 0.8; }
        .free .status-badge { border: 1px solid var(--color-green); color: var(--color-green); }

        /* åŠ è½½æ¡ */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display: flex; justify-content: center; align-items: center; color: var(--color-gold); font-size: 3vh;}
    </style>
</head>
<body>

<div id="loader">æ­£åœ¨è¿æ¥ç»´æ ¼è¡¨...</div>

<header>
    <div class="brand">ç¯è¾°æ–‡åŒ–å‘½ç†æœåŠ¡ä¸­å¿ƒ</div>
    <div class="date-info">
        <div id="lunar" style="font-family: var(--font-title); font-size: 1.2em;">æ•°æ®åŒæ­¥ä¸­...</div>
        <div id="clock" style="font-family: 'Times New Roman'; font-size: 1.5em; margin-top: 5px;">00:00:00</div>
    </div>
</header>

<main>
    <aside class="sidebar glass-panel">
        <div class="stat-card"><div class="stat-label">ä»Šæ—¥ç»“ç¼˜</div><div class="stat-num" id="count-total">0</div></div>
        <div class="stat-card"><div class="stat-label">ç­‰å¾…æ¥å¼•</div><div class="stat-num" id="count-wait" style="color:#fff">0</div></div>
        <div class="marquee-box">
            <div style="text-align:center; color:var(--color-gold); border-bottom:2px solid var(--color-red); padding-bottom:10px; margin-bottom:10px; font-family:var(--font-title); font-size: 2.5vh;">ğŸ“… æœˆåº¦æ’æœŸæ¦‚è§ˆ</div>
            <div class="marquee-content" id="future-list"></div>
        </div>
    </aside>

    <div class="master-grid" id="master-grid"></div>
</main>

<script>
    // ==========================================
    // ğŸ”´ é…ç½®åŒº (å·²å¡«å…¥æ‚¨çš„ä¿¡æ¯)
    // ==========================================
    const VIKA_CONFIG = {
        TOKEN: "uskRMINs8MRQZD07iTNuNnl", 
        DATASHEET_ID: "dstmgbUypiy0LbUzwF" 
    };

    // ==========================================
    // ğŸ§  æ ¸å¿ƒé€»è¾‘
    // ==========================================
    
    // 1. ä»ç»´æ ¼è¡¨æ‹‰å–æ•°æ®
    async function fetchData() {
        // æ„å»ºè¯·æ±‚ URL
        const url = `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.DATASHEET_ID}/records?viewId=&fieldKey=name`;
        
        try {
            const response = await fetch(url, {
                headers: { "Authorization": `Bearer ${VIKA_CONFIG.TOKEN}` }
            });
            const json = await response.json();
            
            if (json.code === 200) {
                processData(json.data.records);
                document.getElementById('lunar').innerText = "ä¹™å·³å¹´ Â· é¡ºé¢‚æ—¶ç¥º";
                document.getElementById('loader').style.display = 'none'; // éšè—åŠ è½½
            } else {
                console.error("Vika Error:", json.message);
                document.getElementById('loader').innerText = "é…ç½®é”™è¯¯: " + json.message;
            }
        } catch (err) {
            console.error("Network Error:", err);
            // ä¸éšè—åŠ è½½æ¡ï¼Œæ˜¾ç¤ºé‡è¯•çŠ¶æ€
            document.getElementById('loader').innerText = "ç½‘ç»œè¿æ¥ä¸­...";
        }
    }

    // 2. å¤„ç†æ•°æ®
    function processData(records) {
        const mastersMap = {};
        const appointments = [];

        records.forEach(r => {
            const f = r.fields;
            if (!f['å¤§å¸ˆ']) return;

            // æå–å¤§å¸ˆå¤´åƒ
            // å¦‚æœ map é‡Œæ²¡æœ‰è¿™ä¸ªå¤§å¸ˆï¼Œæˆ–è€…å½“å‰è¡Œæœ‰å¤´åƒè€Œ map é‡Œæ²¡æœ‰ï¼Œåˆ™æ›´æ–°
            if (!mastersMap[f['å¤§å¸ˆ']] || (f['å¤´åƒ'] && !mastersMap[f['å¤§å¸ˆ']].img)) {
                let avatarUrl = "";
                if (f['å¤´åƒ'] && f['å¤´åƒ'].length > 0) {
                    avatarUrl = f['å¤´åƒ'][0].url; 
                }
                mastersMap[f['å¤§å¸ˆ']] = { name: f['å¤§å¸ˆ'], img: avatarUrl };
            }

            // æå–é¢„çº¦
            if (f['æ—¥æœŸ'] && f['æ—¶é—´']) {
                appointments.push({
                    master: f['å¤§å¸ˆ'],
                    client: f['å®¢æˆ·'] || "ç¥ç§˜ç¼˜ä¸»",
                    date: f['æ—¥æœŸ'],
                    start: f['æ—¶é—´'],
                    duration: f['æ—¶é•¿'] || 60
                });
            }
        });

        // å¼ºåˆ¶å¡«æ»¡4ä¸ªä½ç½® (å¦‚æœä¸å¤Ÿ4ä¸ªå¤§å¸ˆï¼Œè¡¥ç©ºä½ï¼Œä¿è¯å¸ƒå±€ä¸ä¹±)
        const mastersList = Object.values(mastersMap);
        // å¦‚æœæ‚¨å¸Œæœ›é¡ºåºå›ºå®šï¼Œå¯ä»¥åœ¨ç»´æ ¼è¡¨é‡ŒåŠ ä¸€ä¸ªåºå·åˆ—ï¼Œæˆ–è€…åœ¨è¿™é‡Œå†™æ­»é¡ºåº
        
        renderScreen(mastersList, appointments);
    }

    // 3. æ¸²æŸ“å±å¹•
    function renderScreen(masters, appointments) {
        renderGrid(masters, appointments);
        renderSidebar(appointments);
    }

    function renderGrid(masters, appointments) {
        const grid = document.getElementById('master-grid');
        grid.innerHTML = '';
        
        const now = new Date();
        const curMins = now.getHours() * 60 + now.getMinutes();
        const todayStr = getTodayStr();

        // éå†æ‰€æœ‰å¤§å¸ˆ
        masters.forEach(m => {
            const myAppts = appointments.filter(a => a.master === m.name && a.date === todayStr);
            
            let status = 'free';
            let active = null;
            let next = null;

            myAppts.forEach(a => {
                const s = getMins(a.start);
                const e = s + parseInt(a.duration);
                if (curMins >= s && curMins < e) {
                    status = 'busy';
                    active = { ...a, end: formatTime(e) };
                } else if (curMins < s) {
                    if (!next || s < getMins(next.start)) next = a;
                }
            });

            // å¤´åƒå®¹é”™å¤„ç†ï¼šå¦‚æœæ²¡æœ‰å›¾ï¼Œæ˜¾ç¤ºæ–‡å­—å¤´åƒ
            let avatarHtml = '';
            if (m.img) {
                // å¢åŠ  onerror å¤„ç†ï¼Œé˜²æ­¢é“¾æ¥å¤±æ•ˆå¯¼è‡´è£‚å›¾
                avatarHtml = `<img src="${m.img}" class="avatar-img" onerror="this.style.display='none';this.parentNode.innerHTML='<div style=\'color:#d4af37;font-size:5vh;line-height:15vh;\'>${m.name[0]}</div>'">`;
            } else {
                avatarHtml = `<div style="color:var(--color-gold);font-size:5vh;line-height:15vh;text-align:center;">${m.name[0]}</div>`;
            }

            let infoHtml = '';
            if (status === 'busy') {
                infoHtml = `
                    <div class="client-info-box">
                        <div class="c-name">${active.client}</div>
                        <div class="c-time">${active.start} - ${active.end}</div>
                    </div>
                    <div class="status-badge">æ¨æ¼”ä¸­ Â· å‹¿æ‰°</div>
                `;
            } else {
                infoHtml = `
                    <div class="client-info-box">
                        <div style="color:#aaa;">${next ? 'ä¸‹ä¸€ä½: '+next.start : 'ä»Šæ—¥ç©ºé—²'}</div>
                        <div style="color:#888;">${next ? next.client : ''}</div>
                    </div>
                    <div class="status-badge">è™šä½ä»¥å¾…</div>
                `;
            }

            const card = document.createElement('div');
            card.className = `glass-panel master-card ${status}`;
            card.innerHTML = `
                <div class="avatar-frame">${avatarHtml}</div>
                <div class="master-name">${m.name}</div>
                ${infoHtml}
            `;
            grid.appendChild(card);
        });
    }

    function renderSidebar(appointments) {
        const todayStr = getTodayStr();
        const todayAppts = appointments.filter(a => a.date === todayStr);
        
        document.getElementById('count-total').innerText = todayAppts.length;
        
        const now = new Date();
        const curMins = now.getHours() * 60 + now.getMinutes();
        const wait = todayAppts.filter(a => (getMins(a.start) + parseInt(a.duration)) > curMins).length;
        document.getElementById('count-wait').innerText = wait;

        const listDiv = document.getElementById('future-list');
        const futureAppts = appointments.filter(a => a.date > todayStr || (a.date === todayStr && getMins(a.start) > curMins));
        
        futureAppts.sort((a,b) => (a.date+a.start).localeCompare(b.date+b.start));
        
        let html = '';
        if (futureAppts.length === 0) html = '<div style="text-align:center; color:#666; padding:20px;">æš‚æ— æ’æœŸ</div>';
        
        futureAppts.forEach(a => {
            html += `<div class="future-item">
                        <span style="color:var(--color-gold)">${a.date.slice(5)} ${a.start}</span>
                        <span>${a.master} Â· ${a.client}</span>
                     </div>`;
        });
        
        if (listDiv.innerHTML !== html) listDiv.innerHTML = html;
    }

    // å·¥å…·å‡½æ•°
    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour12:false}); }
    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function getMins(t) { const [h,m]=t.split(':').map(Number); return h*60+m; }
    function formatTime(m) { let h=Math.floor(m/60), mm=m%60; if(h>=24) h-=24; return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }

    // ğŸš€ å¯åŠ¨
    setInterval(updateClock, 1000);
    setInterval(fetchData, 30 * 1000); // æ¯30ç§’åŒæ­¥ä¸€æ¬¡
    fetchData(); // ç«‹å³åŒæ­¥

</script>
</body>
</html>
