<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>ç¯è¾°æ–‡åŒ– Â· ç»ˆæè¿è¡Œç‰ˆ</title>
    <style>
        /* =========================================
           ğŸ¨ è§†è§‰é…ç½®
           ========================================= */
        :root {
            --bg-image: url('https://s21.ax1x.com/2025/11/25/pZAQ501.png');
            --glass-bg: rgba(0, 0, 0, 0.75); --glass-border: rgba(212, 175, 55, 0.6);
            --font-title: "KaiTi", "STKaiti", "BiauKai", serif; --font-body: "Songti SC", "SimSun", serif; 
            --color-gold: #ffd700; --color-red: #ff4d4d; --color-green: #4caf50; --text-main: #ffffff;
        }
        body { margin: 0; background: var(--bg-image); background-size: cover; background-position: center; color: var(--text-main); font-family: var(--font-body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        header { height: 12vh; display: flex; justify-content: center; align-items: center; border-bottom: 3px double var(--color-gold); background: rgba(0,0,0,0.6); position: relative; }
        .brand { font-family: var(--font-title); font-size: 5vh; color: var(--color-gold); letter-spacing: 5px; font-weight: bold; text-shadow: 0 2px 5px #000; }
        .date-info { position: absolute; right: 30px; text-align: right; color: #ddd; font-size: 2.5vh; }
        main { flex: 1; display: flex; padding: 2vh; gap: 2vh; }
        .glass-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .sidebar { flex: 25; display: flex; flex-direction: column; gap: 2vh; }
        .stat-card { padding: 2vh; text-align: center; border-bottom: 1px dashed rgba(255,255,255,0.2); }
        .stat-label { font-size: 2.5vh; color: #ccc; margin-bottom: 1vh; font-family: var(--font-title);}
        .stat-num { font-family: 'Times New Roman'; font-size: 7vh; color: var(--color-gold); font-weight: bold; line-height: 1;}
        .marquee-box { flex: 1; padding: 2vh; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; width: 100%; animation: scrollUp 25s linear infinite; }
        .future-item { padding: 1.5vh 0; border-bottom: 1px dashed #555; font-size: 2.2vh; display: flex; justify-content: space-between; }
        @keyframes scrollUp { 0% { top: 100%; } 100% { top: -200%; } }
        .master-grid { flex: 75; display: grid; grid-template-columns: repeat(4, 1fr); gap: 2vh; }
        .master-card { display: flex; flex-direction: column; align-items: center; padding: 2vh; transition: transform 0.3s; }
        .avatar-frame { width: 16vh; height: 16vh; border-radius: 50%; border: 3px solid var(--color-gold); padding: 3px; background: #000; margin-bottom: 2vh; box-shadow: 0 5px 20px #000; overflow: hidden; display: flex; justify-content: center; align-items: center; position: relative; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .master-name { font-family: var(--font-title); font-size: 3.5vh; color: var(--color-gold); margin-bottom: 2vh; letter-spacing: 3px; }
        .status-badge { margin-top: auto; padding: 1vh 0; width: 100%; text-align: center; font-size: 2.5vh; border-radius: 4px; font-family: var(--font-title); font-weight: bold; }
        .client-info-box { width: 100%; min-height: 8vh; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 1vh; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .c-name { font-size: 3vh; color: #fff; font-weight: bold; margin-bottom: 0.5vh; }
        .c-time { color: #aaa; font-family: 'Times New Roman'; font-size: 2.2vh; }
        .busy { border-color: var(--color-red); } .busy .avatar-frame { border-color: var(--color-red); } .busy .status-badge { background: var(--color-red); color: #fff; }
        .free { border-color: var(--color-green); } .free .avatar-frame { filter: grayscale(100%); opacity: 0.8; } .free .status-badge { border: 1px solid var(--color-green); color: var(--color-green); }

        /* âš™ï¸ è®¾ç½®å¼¹çª—æ ·å¼ */
        #config-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .config-box {
            background: #222; padding: 40px; border: 2px solid var(--color-gold); border-radius: 10px; width: 500px;
            text-align: center;
        }
        .config-box h2 { color: var(--color-gold); margin-bottom: 20px; font-family: var(--font-title); }
        .config-input {
            width: 90%; padding: 15px; margin-bottom: 20px; background: #333; border: 1px solid #555; color: #fff; font-size: 16px; border-radius: 5px;
        }
        .config-btn {
            padding: 15px 40px; background: var(--color-gold); border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px;
        }
        #debug-log {
            position: fixed; bottom: 0; left: 0; width: 100%; max-height: 200px; 
            background: rgba(0,0,0,0.8); color: #0f0; font-size: 12px; 
            overflow-y: auto; pointer-events: none; padding: 10px; box-sizing: border-box;
            z-index: 9998; display: none;
        }
    </style>
</head>
<body>

<div id="debug-log"></div>

<div id="config-modal" style="display:none;">
    <div class="config-box">
        <h2>âš™ï¸ ç³»ç»Ÿåˆå§‹åŒ–é…ç½®</h2>
        <p style="color:#aaa; margin-bottom:20px;">è¯·è¾“å…¥æ‚¨çš„ç»´æ ¼è¡¨ä¿¡æ¯ (ä»…éœ€è¾“å…¥ä¸€æ¬¡)</p>
        
        <input type="text" id="input-token" class="config-input" placeholder="ç²˜è´´ API Token (uskå¼€å¤´)">
        <input type="text" id="input-id" class="config-input" placeholder="ç²˜è´´ è¡¨æ ¼ ID (dstå¼€å¤´)">
        
        <button class="config-btn" onclick="saveConfig()">ä¿å­˜å¹¶è¿æ¥</button>
        <p style="color:#ff4d4d; margin-top:15px; font-size:14px;" id="config-error"></p>
    </div>
</div>

<header>
    <div class="brand">ç¯è¾°æ–‡åŒ–å‘½ç†æœåŠ¡ä¸­å¿ƒ</div>
    <div class="date-info">
        <div id="lunar" style="font-family: var(--font-title); font-size: 1.2em;">ç³»ç»Ÿå¯åŠ¨ä¸­...</div>
        <div id="clock" style="font-family: 'Times New Roman'; font-size: 1.5em; margin-top: 5px;">00:00:00</div>
    </div>
</header>

<main>
    <aside class="sidebar glass-panel">
        <div class="stat-card"><div class="stat-label">ä»Šæ—¥ç»“ç¼˜</div><div class="stat-num" id="count-total">-</div></div>
        <div class="stat-card"><div class="stat-label">ç­‰å¾…æ¥å¼•</div><div class="stat-num" id="count-wait" style="color:#fff">-</div></div>
        <div class="marquee-box">
            <div style="text-align:center; color:var(--color-gold); border-bottom:2px solid var(--color-red); padding-bottom:10px; margin-bottom:10px; font-family:var(--font-title); font-size: 2.5vh;">ğŸ“… æœˆåº¦æ’æœŸæ¦‚è§ˆ</div>
            <div class="marquee-content" id="future-list"></div>
        </div>
    </aside>
    <div class="master-grid" id="master-grid"></div>
</main>

<script>
    window.onerror = function(msg, url, line) {
        const logBox = document.getElementById('debug-log');
        logBox.style.display = 'block';
        logBox.innerHTML += `<div style="color:red;">ğŸ’¥ ä¸¥é‡é”™è¯¯: ${msg} (Line: ${line})</div>`;
        // å¦‚æœå‡ºé”™ï¼Œæ˜¾ç¤ºé…ç½®å¼¹çª—è®©ç”¨æˆ·é‡å¡«
        document.getElementById('config-modal').style.display = 'flex';
    };
</script>

<script>
    // ==========================================
    // ğŸ§  æ ¸å¿ƒé€»è¾‘ (ES5å…¼å®¹å†™æ³•ï¼Œé˜²æ­¢è€æµè§ˆå™¨æŠ¥é”™)
    // ==========================================
    
    var VIKA_TOKEN = uskRMINs8MRQZD07iTNuNnl('vika_token') || "";
    var VIKA_ID = dstmgbUypiy0LbUzwF('vika_id') || "";

    function init() {
        // 1. æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®
        if (!VIKA_TOKEN || !VIKA_ID) {
            document.getElementById('config-modal').style.display = 'flex';
        } else {
            document.getElementById('config-modal').style.display = 'none';
            fetchData();
            // å¼€å¯è‡ªåŠ¨åˆ·æ–°
            setInterval(fetchData, 30000);
        }
        
        setInterval(updateClock, 1000);
        updateClock();
    }

    function saveConfig() {
        var t = document.getElementById('input-token').value.trim();
        var i = document.getElementById('input-id').value.trim();
        
        if (!t.startsWith('usk')) {
            document.getElementById('config-error').innerText = "Token æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä»¥ usk å¼€å¤´";
            return;
        }
        if (!i.startsWith('dst')) {
            document.getElementById('config-error').innerText = "ID æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»ä»¥ dst å¼€å¤´";
            return;
        }

        localStorage.setItem('vika_token', t);
        localStorage.setItem('vika_id', i);
        
        // åˆ·æ–°é¡µé¢
        location.reload();
    }

    function log(msg, isError) {
        var logBox = document.getElementById('debug-log');
        if(isError) logBox.style.display = 'block';
        var color = isError ? 'red' : '#0f0';
        logBox.innerHTML += '<div style="color:'+color+'">'+msg+'</div>';
    }

    function fetchData() {
        // åŠ ä¸Šéšæœºæ•°é˜²ç¼“å­˜
        var url = "https://api.vika.cn/fusion/v1/datasheets/" + VIKA_ID + "/records?fieldKey=name&t=" + new Date().getTime();
        
        fetch(url, {
            headers: { "Authorization": "Bearer " + VIKA_TOKEN }
        })
        .then(function(response) {
            if (!response.ok) {
                if(response.status === 401) throw new Error("Token æ— æ•ˆ (401)");
                if(response.status === 404) throw new Error("è¡¨æ ¼ ID é”™è¯¯ (404)");
                throw new Error("æœåŠ¡å™¨é”™è¯¯: " + response.status);
            }
            return response.json();
        })
        .then(function(json) {
            if (json.code === 200) {
                processData(json.data.records);
                document.getElementById('lunar').innerText = "ä¹™å·³å¹´ Â· é¡ºé¢‚æ—¶ç¥º";
                // æˆåŠŸè¿æ¥ï¼Œéšè—æ—¥å¿—
                document.getElementById('debug-log').style.display = 'none';
            } else {
                throw new Error("API Error: " + json.message);
            }
        })
        .catch(function(err) {
            log("è¿æ¥å¤±è´¥: " + err.message, true);
            // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå¼¹å‡ºé…ç½®æ¡†è®©ç”¨æˆ·é‡å¡«
            if (err.message.includes("401") || err.message.includes("404")) {
                document.getElementById('config-modal').style.display = 'flex';
                document.getElementById('config-error').innerText = err.message;
            }
        });
    }

    function processData(records) {
        var mastersMap = {};
        var appointments = [];

        records.forEach(function(r) {
            var f = r.fields;
            if (!f['å¤§å¸ˆ']) return;

            var avatarUrl = "";
            var rawAvatar = f['å¤´åƒ'];
            if (rawAvatar) {
                if (Array.isArray(rawAvatar) && rawAvatar.length > 0) avatarUrl = rawAvatar[0].url;
                else if (typeof rawAvatar === 'string') avatarUrl = rawAvatar;
            }

            if (!mastersMap[f['å¤§å¸ˆ']] || (avatarUrl && !mastersMap[f['å¤§å¸ˆ']].img)) {
                mastersMap[f['å¤§å¸ˆ']] = { name: f['å¤§å¸ˆ'], img: avatarUrl };
            }

            if (f['æ—¥æœŸ'] && f['æ—¶é—´']) {
                appointments.push({
                    master: f['å¤§å¸ˆ'],
                    client: f['å®¢æˆ·'] || "ç¥ç§˜ç¼˜ä¸»",
                    date: f['æ—¥æœŸ'],
                    start: f['æ—¶é—´'],
                    duration: f['æ—¶é•¿'] || 60
                });
            }
        });

        var mastersList = [];
        for (var key in mastersMap) { mastersList.push(mastersMap[key]); }
        
        renderScreen(mastersList, appointments);
    }

    function renderScreen(masters, appointments) {
        var grid = document.getElementById('master-grid');
        grid.innerHTML = '';
        var now = new Date();
        var curMins = now.getHours() * 60 + now.getMinutes();
        var todayStr = getTodayStr();

        masters.forEach(function(m) {
            var myAppts = appointments.filter(function(a) { return a.master === m.name && a.date === todayStr; });
            var status = 'free';
            var active = null;
            var next = null;

            myAppts.forEach(function(a) {
                var s = getMins(a.start);
                var e = s + parseInt(a.duration);
                if (curMins >= s && curMins < e) { status = 'busy'; active = {client: a.client, start: a.start, end: formatTime(e)}; }
                else if (curMins < s) { if(!next || s < getMins(next.start)) next = a; }
            });

            var avatarHtml = '';
            if (m.img) {
                avatarHtml = '<img src="' + m.img + '" class="avatar-img" onerror="this.style.display=\'none\'">';
            } else {
                avatarHtml = '<div style="width:100%;height:100%;background:#000;"></div>';
            }

            var infoHtml = status === 'busy' 
                ? '<div class="client-info-box"><div class="c-name">' + active.client + '</div><div class="c-time">' + active.start + ' - ' + active.end + '</div></div><div class="status-badge">æ­£åœ¨æ¨æ¼”</div>'
                : '<div class="client-info-box"><div style="color:#aaa;">' + (next?'ä¸‹ä¸€ä½:'+next.start:'ä»Šæ—¥ç©ºé—²') + '</div><div style="color:#888;">' + (next?next.client:'') + '</div></div><div class="status-badge">è™šä½ä»¥å¾…</div>';

            var card = document.createElement('div');
            card.className = 'glass-panel master-card ' + status;
            card.innerHTML = '<div class="avatar-frame">' + avatarHtml + '</div><div class="master-name">' + m.name + '</div>' + infoHtml;
            grid.appendChild(card);
        });
        
        renderSidebar(appointments);
    }

    function renderSidebar(appointments) {
        var todayStr = getTodayStr();
        var todayAppts = appointments.filter(function(a) { return a.date === todayStr; });
        document.getElementById('count-total').innerText = todayAppts.length;
        
        var now = new Date(); var curMins = now.getHours()*60 + now.getMinutes();
        var waitCount = todayAppts.filter(function(a) { return (getMins(a.start)+parseInt(a.duration))>curMins; }).length;
        document.getElementById('count-wait').innerText = waitCount;

        var listDiv = document.getElementById('future-list');
        var futureAppts = appointments.filter(function(a) { return a.date > todayStr || (a.date === todayStr && getMins(a.start) > curMins); });
        futureAppts.sort(function(a,b) { return (a.date+a.start).localeCompare(b.date+b.start); });
        
        var html = '';
        if (futureAppts.length === 0) html = '<div style="text-align:center; color:#666; padding:20px;">æš‚æ— æ’æœŸ</div>';
        
        futureAppts.forEach(function(a) {
            html += '<div class="future-item"><span style="color:var(--color-gold)">' + a.date.slice(5) + ' ' + a.start + '</span><span>' + a.master + '</span></div>';
        });
        if (listDiv.innerHTML !== html) listDiv.innerHTML = html;
    }

    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour12:false}); }
    function getTodayStr() { var d = new Date(); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }
    function getMins(t) { var parts=t.split(':'); return parseInt(parts[0])*60 + parseInt(parts[1]); }
    function formatTime(m) { var h=Math.floor(m/60); var mm=m%60; if(h>=24) h-=24; return String(h).padStart(2,'0') + ':' + String(mm).padStart(2,'0'); }

    // å¯åŠ¨
    init();

</script>
</body>
</html>
