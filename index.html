<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>ç¯è¾°æ–‡åŒ– Â· ç”µè„‘æµ‹è¯•ç‰ˆ</title>
    <style>
        /* =========================================
           ğŸ¨ è§†è§‰é…ç½®
           ========================================= */
        :root {
            --bg-image: url('https://s21.ax1x.com/2025/11/25/pZAQ501.png');
            --glass-bg: rgba(0, 0, 0, 0.75); 
            --glass-border: rgba(212, 175, 55, 0.6);
            --font-title: "KaiTi", "STKaiti", "BiauKai", serif; 
            --font-body: "Songti SC", "SimSun", serif; 
            --color-gold: #ffd700; 
            --color-red: #ff4d4d; 
            --color-green: #4caf50; 
            --text-main: #ffffff;
        }

        body {
            margin: 0; background: var(--bg-image); background-size: cover; background-position: center; 
            color: var(--text-main); font-family: var(--font-body); height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        header {
            height: 12vh; display: flex; justify-content: center; align-items: center;
            border-bottom: 3px double var(--color-gold); background: rgba(0,0,0,0.6); position: relative;
        }
        .brand {
            font-family: var(--font-title); font-size: 5vh; color: var(--color-gold); 
            letter-spacing: 5px; font-weight: bold; text-shadow: 0 2px 5px #000; 
        }
        .date-info { position: absolute; right: 30px; text-align: right; color: #ddd; font-size: 2.5vh; }

        main { flex: 1; display: flex; padding: 2vh; gap: 2vh; }

        .glass-panel {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        }

        .sidebar { flex: 25; display: flex; flex-direction: column; gap: 2vh; }
        .stat-card { padding: 2vh; text-align: center; border-bottom: 1px dashed rgba(255,255,255,0.2); }
        .stat-label { font-size: 2.5vh; color: #ccc; margin-bottom: 1vh; font-family: var(--font-title);}
        .stat-num { font-family: 'Times New Roman'; font-size: 7vh; color: var(--color-gold); font-weight: bold; line-height: 1;}
        .marquee-box { flex: 1; padding: 2vh; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; width: 100%; animation: scrollUp 25s linear infinite; }
        .future-item { padding: 1.5vh 0; border-bottom: 1px dashed #555; font-size: 2.2vh; display: flex; justify-content: space-between; }
        @keyframes scrollUp { 0% { top: 100%; } 100% { top: -200%; } }

        .master-grid { flex: 75; display: grid; grid-template-columns: repeat(4, 1fr); gap: 2vh; }
        .master-card { display: flex; flex-direction: column; align-items: center; padding: 2vh; transition: transform 0.3s; }
        
        .avatar-frame {
            width: 16vh; height: 16vh; border-radius: 50%; border: 3px solid var(--color-gold);
            padding: 3px; background: #000; margin-bottom: 2vh; box-shadow: 0 5px 20px #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        
        .master-name { font-family: var(--font-title); font-size: 3.5vh; color: var(--color-gold); margin-bottom: 2vh; letter-spacing: 3px; }
        .status-badge { margin-top: auto; padding: 1vh 0; width: 100%; text-align: center; font-size: 2.5vh; border-radius: 4px; font-family: var(--font-title); font-weight: bold; }
        .client-info-box { width: 100%; min-height: 8vh; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 1vh; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .c-name { font-size: 3vh; color: #fff; font-weight: bold; margin-bottom: 0.5vh; }
        .c-time { color: #aaa; font-family: 'Times New Roman'; font-size: 2.2vh; }

        .busy { border-color: var(--color-red); } .busy .avatar-frame { border-color: var(--color-red); } .busy .status-badge { background: var(--color-red); color: #fff; }
        .free { border-color: var(--color-green); } .free .avatar-frame { filter: grayscale(100%); opacity: 0.8; } .free .status-badge { border: 1px solid var(--color-green); color: var(--color-green); }

        /* æç¤ºæ¡ */
        #status-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9);
            color: #fff; font-size: 14px; padding: 5px; text-align: center; z-index: 9999;
        }
    </style>
</head>
<body>

<header>
    <div class="brand">ç¯è¾°æ–‡åŒ–å‘½ç†æœåŠ¡ä¸­å¿ƒ</div>
    <div class="date-info">
        <div id="lunar" style="font-family: var(--font-title); font-size: 1.2em;">æ­£åœ¨åˆå§‹åŒ–...</div>
        <div id="clock" style="font-family: 'Times New Roman'; font-size: 1.5em; margin-top: 5px;">00:00:00</div>
    </div>
</header>

<main>
    <aside class="sidebar glass-panel">
        <div class="stat-card"><div class="stat-label">ä»Šæ—¥ç»“ç¼˜</div><div class="stat-num" id="count-total">-</div></div>
        <div class="stat-card"><div class="stat-label">ç­‰å¾…æ¥å¼•</div><div class="stat-num" id="count-wait" style="color:#fff">-</div></div>
        <div class="marquee-box">
            <div style="text-align:center; color:var(--color-gold); border-bottom:2px solid var(--color-red); padding-bottom:10px; margin-bottom:10px; font-family:var(--font-title); font-size: 2.5vh;">ğŸ“… æœˆåº¦æ’æœŸæ¦‚è§ˆ</div>
            <div class="marquee-content" id="future-list"></div>
        </div>
    </aside>
    <div class="master-grid" id="master-grid"></div>
</main>

<div id="status-bar">ç³»ç»ŸçŠ¶æ€æ£€æµ‹ä¸­...</div>

<script>
    // ==========================================
    // ğŸ”´ æ‚¨çš„é…ç½® (ç¡®è®¤æ— è¯¯)
    // ==========================================
    var VIKA_CONFIG = {
        TOKEN: "uskRMINs8MRQZD07iTNuNnl", 
        DATASHEET_ID: "dstmgbUypiy0LbUzwF" 
    };

    // ==========================================
    // ğŸ§ª æ¨¡æ‹Ÿæ•°æ® (å¦‚æœè¿ä¸ä¸Šç½‘ï¼Œå°±æ˜¾ç¤ºè¿™ä¸ª)
    // ==========================================
    var MOCK_DATA = [
        { fields: { "å¤§å¸ˆ": "é™ˆå¤§å¸ˆ", "å¤´åƒ": "", "æ—¥æœŸ": getTodayStr(), "æ—¶é—´": "14:00", "å®¢æˆ·": "æµ‹è¯•å®¢æˆ·A", "æ—¶é•¿": 60 } },
        { fields: { "å¤§å¸ˆ": "æ—å¤§å¸ˆ", "å¤´åƒ": "", "æ—¥æœŸ": getTodayStr(), "æ—¶é—´": "15:30", "å®¢æˆ·": "æµ‹è¯•å®¢æˆ·B", "æ—¶é•¿": 60 } },
        { fields: { "å¤§å¸ˆ": "ç‹å¤§å¸ˆ", "å¤´åƒ": "", "æ—¥æœŸ": "2025-12-01", "æ—¶é—´": "09:00", "å®¢æˆ·": "æœªæ¥é¢„çº¦", "æ—¶é•¿": 60 } },
        { fields: { "å¤§å¸ˆ": "èµµå¤§å¸ˆ", "å¤´åƒ": "", "æ—¥æœŸ": getTodayStr(), "æ—¶é—´": "10:00", "å®¢æˆ·": "å·²å®Œæˆå®¢æˆ·", "æ—¶é•¿": 60 } }
    ];

    // ==========================================
    // ğŸ§  æ ¸å¿ƒé€»è¾‘
    // ==========================================
    
    function updateStatus(msg, isError) {
        var el = document.getElementById('status-bar');
        el.innerText = msg;
        el.style.color = isError ? '#ff4d4d' : '#4caf50';
    }

    function fetchData() {
        updateStatus("æ­£åœ¨å°è¯•è¿æ¥äº‘ç«¯...", false);
        
        var url = "https://api.vika.cn/fusion/v1/datasheets/" + VIKA_CONFIG.DATASHEET_ID + "/records?fieldKey=name";
        
        fetch(url, {
            headers: { "Authorization": "Bearer " + VIKA_CONFIG.TOKEN },
            cache: "no-store"
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error("è¿æ¥å¤±è´¥: " + response.status);
            }
            return response.json();
        })
        .then(function(json) {
            if (json.code === 200) {
                updateStatus("âœ… äº‘ç«¯æ•°æ®è¿æ¥æˆåŠŸ", false);
                processData(json.data.records);
                document.getElementById('lunar').innerText = "ä¹™å·³å¹´ Â· é¡ºé¢‚æ—¶ç¥º (åœ¨çº¿)";
            } else {
                throw new Error("API é”™è¯¯: " + json.message);
            }
        })
        .catch(function(err) {
            console.error(err);
            // ğŸš¨ å…³é”®ï¼šå¦‚æœå‡ºé”™ï¼ŒåŠ è½½æ¨¡æ‹Ÿæ•°æ®
            updateStatus("âš ï¸ ç”µè„‘ç«¯è¿æ¥å—é™ (CORS)ï¼Œå·²åˆ‡æ¢è‡³ã€æ¨¡æ‹Ÿæ¼”ç¤ºæ¨¡å¼ã€‘ã€‚è¯·æ”¾å¿ƒï¼Œç”µè§†ç«¯é€šå¸¸èƒ½è¿ä¸Šã€‚", true);
            document.getElementById('lunar').innerText = "æ¼”ç¤ºæ¨¡å¼";
            processData(MOCK_DATA);
        });
    }

    function processData(records) {
        var mastersMap = {};
        var appointments = [];

        // é¢„è®¾4ä½å¤§å¸ˆï¼Œé˜²æ­¢ç©ºæ•°æ®å¯¼è‡´æ’ç‰ˆä¹±
        var defaultMasters = ["é™ˆå¤§å¸ˆ", "æ—å¤§å¸ˆ", "ç‹å¤§å¸ˆ", "èµµå¤§å¸ˆ"];
        defaultMasters.forEach(function(name) { mastersMap[name] = {name: name, img: ""}; });

        records.forEach(function(r) {
            var f = r.fields;
            if (!f['å¤§å¸ˆ']) return;

            var avatarUrl = "";
            var rawAvatar = f['å¤´åƒ'];
            if (rawAvatar) {
                if (Array.isArray(rawAvatar) && rawAvatar.length > 0) avatarUrl = rawAvatar[0].url;
                else if (typeof rawAvatar === 'string') avatarUrl = rawAvatar;
            }

            // æ›´æ–°æˆ–æ–°å¢å¤§å¸ˆ
            if (mastersMap[f['å¤§å¸ˆ']]) {
                if
