<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>ç¯è¾°æ–‡åŒ– Â· çº¯å‡€æ•°æ®ç‰ˆ</title>
    <style>
        /* =========================================
           ğŸ¨ è§†è§‰é…ç½®
           ========================================= */
        :root {
            --bg-image: url('https://s21.ax1x.com/2025/11/25/pZAQ501.png');
            --glass-bg: rgba(0, 0, 0, 0.85); 
            --glass-border: rgba(212, 175, 55, 0.6);
            --font-title: "KaiTi", "STKaiti", serif; 
            --font-body: "Songti SC", "SimSun", serif; 
            --color-gold: #ffd700; 
            --color-red: #ff4d4d; 
            --color-green: #4caf50; 
            --color-yellow: #ffaa00; 
            --text-main: #ffffff;
        }

        body {
            margin: 0; background: var(--bg-image); background-size: cover; background-position: center; 
            color: var(--text-main); font-family: var(--font-body); height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* é¡¶éƒ¨ï¼šåªä¿ç•™ LOGO å’Œ æ—¶é—´ï¼Œå»æ‰äº†å¤šä½™çš„æ–‡å­— */
        header {
            height: 12vh; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px double var(--color-gold); background: rgba(0,0,0,0.6); 
            padding: 0 50px; box-sizing: border-box;
        }
        .brand {
            font-family: var(--font-title); font-size: 5vh; color: var(--color-gold); 
            letter-spacing: 5px; font-weight: bold; text-shadow: 0 2px 5px #000; 
        }
        #clock { 
            font-family: 'Times New Roman'; font-size: 5vh; font-weight: bold; color: #ddd; 
            text-shadow: 0 2px 5px #000;
        }

        main { flex: 1; display: flex; padding: 2vh; gap: 2vh; }

        .glass-panel {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        }

        .sidebar { flex: 25; display: flex; flex-direction: column; gap: 2vh; }
        .stat-card { padding: 2vh; text-align: center; border-bottom: 1px dashed rgba(255,255,255,0.2); }
        .stat-label { font-size: 2.5vh; color: #ccc; margin-bottom: 1vh; font-family: var(--font-title);}
        .stat-num { font-family: 'Times New Roman'; font-size: 7vh; color: var(--color-gold); font-weight: bold; line-height: 1;}
        
        .marquee-box { flex: 1; padding: 2vh; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; width: 100%; }
        .scroll-active { animation: scrollUp 40s linear infinite; }
        
        .future-item { padding: 1.5vh 0; border-bottom: 1px dashed #555; font-size: 2.2vh; display: flex; justify-content: space-between; }
        @keyframes scrollUp { 0% { top: 100%; } 100% { top: -300%; } }

        /* å¤§å¸ˆåŒºï¼šè‡ªåŠ¨æ’åˆ—ï¼Œæœ‰å¤šå°‘ä¸ªæ˜¾ç¤ºå¤šå°‘ä¸ª */
        .master-grid { flex: 75; display: grid; grid-template-columns: repeat(auto-fit, minmax(22%, 1fr)); gap: 2vh; align-content: start;}
        .master-card { display: flex; flex-direction: column; align-items: center; padding: 2vh; transition: transform 0.3s; }
        
        .avatar-frame {
            width: 16vh; height: 16vh; border-radius: 50%; border: 3px solid var(--color-gold);
            padding: 3px; background: #000; margin-bottom: 2vh; box-shadow: 0 5px 20px #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        
        .master-name { font-family: var(--font-title); font-size: 3.5vh; color: var(--color-gold); margin-bottom: 2vh; letter-spacing: 3px; }
        .status-badge { margin-top: auto; padding: 1vh 0; width: 100%; text-align: center; font-size: 2.5vh; border-radius: 4px; font-family: var(--font-title); font-weight: bold; }
        .client-info-box { width: 100%; min-height: 8vh; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 1vh; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .c-name { font-size: 3vh; color: #fff; font-weight: bold; margin-bottom: 0.5vh; }
        .c-time { color: #aaa; font-family: 'Times New Roman'; font-size: 2.2vh; }

        .busy { border-color: var(--color-red); } .busy .avatar-frame { border-color: var(--color-red); } .busy .status-badge { background: var(--color-red); color: #fff; }
        .preparing { border-color: var(--color-yellow); } .preparing .avatar-frame { border-color: var(--color-yellow); } .preparing .status-badge { background: var(--color-yellow); color: #000; }
        .free { border-color: var(--color-green); } .free .avatar-frame { filter: grayscale(100%); opacity: 0.8; } .free .status-badge { border: 1px solid var(--color-green); color: var(--color-green); }

        /* çŠ¶æ€æç¤ºå±‚ (å…¨å±å±…ä¸­) */
        #status-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: var(--color-gold); font-size: 3vh;
        }
        #error-detail { color: #ff4d4d; margin-top: 20px; font-size: 2vh; max-width: 80%; text-align: center; }
    </style>
</head>
<body>

<div id="status-layer">
    <div>æ­£åœ¨è¿æ¥ç»´æ ¼è¡¨...</div>
    <div id="error-detail"></div>
</div>

<header>
    <div class="brand">ç¯è¾°æ–‡åŒ–å‘½ç†æœåŠ¡ä¸­å¿ƒ</div>
    <div id="clock">00:00:00</div>
</header>

<main>
    <aside class="sidebar glass-panel">
        <div class="stat-card"><div class="stat-label">ä»Šæ—¥æ€»ç¼˜ä¸»</div><div class="stat-num" id="count-total">0</div></div>
        <div class="stat-card"><div class="stat-label">ç­‰å¾…æ¥å¼•</div><div class="stat-num" id="count-wait" style="color:#fff">0</div></div>
        <div class="marquee-box">
            <div style="text-align:center; color:var(--color-gold); border-bottom:2px solid var(--color-red); padding-bottom:10px; margin-bottom:10px; font-family:var(--font-title); font-size: 2.5vh;">ğŸ“… é¢„çº¦å®å†µ</div>
            <div class="marquee-content" id="future-list"></div>
        </div>
    </aside>
    <div class="master-grid" id="master-grid"></div>
</main>

<script>
    // ==========================================
    // ğŸ”´ é…ç½®åŒº (ç¡®è®¤æ— è¯¯)
    // ==========================================
    const VIKA_CONFIG = {
        TOKEN: "uskRMINs8MRQZD07iTNuNnl", 
        DATASHEET_ID: "dstmgbUypiy0LbUzwF" 
    };

    // ==========================================
    // ğŸ§  æ ¸å¿ƒé€»è¾‘
    // ==========================================
    async function fetchData() {
        // å¼ºåˆ¶ä¸ç¼“å­˜
        const url = `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.DATASHEET_ID}/records?fieldKey=name&t=${new Date().getTime()}`;
        
        try {
            const response = await fetch(url, { headers: { "Authorization": `Bearer ${VIKA_CONFIG.TOKEN}` } });
            
            if (!response.ok) {
                // ğŸ”´ å¦‚æœHTTPçŠ¶æ€ç ä¸æ˜¯200ï¼Œç›´æ¥æŠ¥é”™
                showError(`è¿æ¥å¤±è´¥: ${response.status} (è¯·æ£€æŸ¥Tokenæˆ–ID)`);
                return;
            }

            const json = await response.json();
            
            if (json.code === 200) {
                const records = json.data.records;
                // âœ… åªæœ‰æ‹¿åˆ°æ•°æ®æ‰éšè—é®ç½©å±‚
                document.getElementById('status-layer').style.display = 'none';
                processData(records);
            } else {
                // ğŸ”´ API å†…éƒ¨é”™è¯¯
                showError(`ç»´æ ¼è¡¨æŠ¥é”™: ${json.message}`);
            }
        } catch (err) {
            // ğŸ”´ ç½‘ç»œé”™è¯¯
            showError(`ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥æœåŠ¡å™¨ã€‚\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚`);
        }
    }

    function showError(msg) {
        const el = document.getElementById('status-layer');
        el.style.display = 'flex'; // æ˜¾ç¤ºé®ç½©
        el.innerHTML = `<div style="color:red; font-size:4vh">âš ï¸ ç³»ç»Ÿå¼‚å¸¸</div><div id="error-detail">${msg}</div><button onclick="location.reload()" style="margin-top:20px; padding:10px 30px; font-size:2vh;">é‡è¯•</button>`;
    }

    function processData(records) {
        // 1. åŠ¨æ€æå–å¤§å¸ˆ (ä¸è®¾ä»»ä½•é»˜è®¤å€¼)
        const mastersMap = {};
        const appointments = [];

        records.forEach(r => {
            const f = r.fields;
            const name = f['å¤§å¸ˆ'];
            
            // âš ï¸ åªæœ‰å¡«äº†åå­—çš„è¡Œæ‰æœ‰æ•ˆ
            if (!name) return;

            // A. æŠ“å–å¤§å¸ˆä¿¡æ¯ (è‡ªåŠ¨å»é‡)
            let avatarUrl = "";
            const rawAvatar = f['å¤´åƒ'];
            if (rawAvatar) {
                if (Array.isArray(rawAvatar) && rawAvatar.length > 0) avatarUrl = rawAvatar[0].url;
                else if (typeof rawAvatar === 'string') avatarUrl = rawAvatar;
            }

            // å¦‚æœè¿™ä¸ªåå­—ç¬¬ä¸€æ¬¡å‡ºç°ï¼Œæˆ–è€…æœ‰å¤´åƒäº†ï¼Œå°±å­˜ä¸‹æ¥
            if (!mastersMap[name] || (avatarUrl && !mastersMap[name].img)) {
                mastersMap[name] = { name: name, img: avatarUrl || "" };
            }

            // B. æŠ“å–é¢„çº¦
            if (f['æ—¥æœŸ'] && f['æ—¶é—´']) {
                // è·³è¿‡è¢«å–æ¶ˆçš„
                if (f['çŠ¶æ€å¹²é¢„'] === 'å–æ¶ˆ') return;

                appointments.push({
                    master: name,
                    client: f['å®¢æˆ·'] || "ç¼˜ä¸»",
                    date: String(f['æ—¥æœŸ']), // å¼ºè½¬å­—ç¬¦ä¸²
                    start: String(f['æ—¶é—´']).trim(), 
                    duration: parseInt(f['æ—¶é•¿']) || 60,
                    override: f['çŠ¶æ€å¹²é¢„']
                });
            }
        });

        // è½¬ä¸ºæ•°ç»„ï¼ŒæŒ‰ä¸­æ–‡æ‹¼éŸ³æ’åº (ä¿è¯é¡ºåºç¨³å®š)
        const mastersList = Object.values(mastersMap).sort((a,b) => a.name.localeCompare(b.name, 'zh-Hans-CN'));
        
        // ğŸ”´ å¦‚æœæ²¡æœ‰æå–åˆ°ä»»ä½•å¤§å¸ˆï¼Œæ˜¾ç¤ºç©ºæç¤º
        if (mastersList.length === 0) {
            document.getElementById('master-grid').innerHTML = '<div style="width:100%; text-align:center; color:#666; font-size:3vh; margin-top:20vh; grid-column: 1 / -1;">æš‚æ— å¤§å¸ˆæ•°æ®<br>è¯·åœ¨ç»´æ ¼è¡¨æ·»åŠ æ•°æ®</div>';
            // ä¹Ÿè¦æ¸…ç©ºä¾§è¾¹æ 
            renderSidebar([], getTodayStr(), 0);
            return;
        }

        renderScreen(mastersList, appointments);
    }

    function renderScreen(masters, appointments) {
        const grid = document.getElementById('master-grid');
        grid.innerHTML = '';
        
        const now = new Date();
        const curMins = now.getHours() * 60 + now.getMinutes();
        const todayStr = getTodayStr();

        masters.forEach(m => {
            let status = 'free';
            let active = null;
            let next = null;

            // ç­›é€‰è¯¥å¤§å¸ˆä»Šå¤©çš„é¢„çº¦
            const myAppts = appointments.filter(a => a.master === m.name && a.date === todayStr);

            myAppts.forEach(a => {
                const s = getMins(a.start);
                const e = s + parseInt(a.duration);

                // çŠ¶æ€åˆ¤å®š
                if (a.override === 'å¼ºåˆ¶å¿™ç¢Œ') {
                    status = 'busy'; active = { client: a.client, start: a.start, end: 'æ‰‹åŠ¨' };
                    return; 
                }
                if (a.override === 'å¼ºåˆ¶ç©ºé—²') return;

                if (curMins >= (s - 15) && curMins < s && status !== 'busy') {
                    status = 'preparing'; active = { client: a.client, start: a.start };
                } else if (curMins >= s && curMins < e) {
                    status = 'busy'; active = { client: a.client, start: a.start, end: formatTime(e) };
                } else if (curMins < s) {
                    if (!next || s < getMins(next.start)) next = a;
                }
            });

            let avatarHtml = m.img ? `<img src="${m.img}" class="avatar-img" onerror="this.style.display='none'">` : `<div style="width:100%;height:100%;background:#222;"></div>`;

            let infoHtml = '';
            if (status === 'busy') {
                infoHtml = `<div class="client-info-box"><div class="c-name">${active.client}</div><div class="c-time">${active.start} - ${active.end}</div></div><div class="status-badge">ğŸ›‘ æ­£åœ¨æ¨æ¼”</div>`;
            } else if (status === 'preparing') {
                infoHtml = `<div class="client-info-box" style="border:1px solid var(--color-yellow);"><div class="c-name" style="color:var(--color-yellow);">${active.client}</div><div class="c-time">å³å°†å¼€å§‹ ${active.start}</div></div><div class="status-badge">âš ï¸ å‡†å¤‡æ¥å¼•</div>`;
            } else {
                infoHtml = `<div class="client-info-box"><div style="color:#aaa;">${next?'ä¸‹ä¸€ä½: '+next.start:'ä»Šæ—¥ç©ºé—²'}</div><div style="color:#888;">${next?next.client:''}</div></div><div class="status-badge">ğŸŸ¢ è™šä½ä»¥å¾…</div>`;
            }

            const card = document.createElement('div');
            card.className = `glass-panel master-card ${status}`;
            card.innerHTML = `<div class="avatar-frame">${avatarHtml}</div><div class="master-name">${m.name}</div>${infoHtml}`;
            grid.appendChild(card);
        });
        
        renderSidebar(appointments, todayStr, curMins);
    }

    function renderSidebar(appointments, todayStr, curMins) {
        let futureAppts = appointments.filter(a => {
            if (a.date > todayStr) return true;
            if (a.date === todayStr) {
                return (getMins(a.start) + parseInt(a.duration)) > curMins;
            }
            return false;
        });

        futureAppts.sort((a,b) => {
            if (a.date !== b.date) return a.date.localeCompare(b.date);
            return a.start.localeCompare(b.start);
        });

        const todayTotal = appointments.filter(a => a.date === todayStr).length;
        const todayWait = futureAppts.filter(a => a.date === todayStr).length;
        
        document.getElementById('count-total').innerText = todayTotal;
        document.getElementById('count-wait').innerText = todayWait;

        const listDiv = document.getElementById('future-list');
        let html = '';
        
        if (futureAppts.length === 0) {
            html = '<div style="text-align:center; color:#666; padding:20px;">æš‚æ— å¾…åŠé¢„çº¦</div>';
            listDiv.classList.remove('scroll-active');
        } else {
            if (futureAppts.length > 5) listDiv.classList.add('scroll-active');
            else listDiv.classList.remove('scroll-active');

            futureAppts.slice(0, 30).forEach(a => {
                let dateDisplay = a.date === todayStr ? "ä»Šæ—¥" : a.date.slice(5);
                html += `<div class="future-item"><span style="color:var(--color-gold)">${dateDisplay} ${a.start}</span><span>${a.master} Â· ${a.client}</span></div>`;
            });
        }
        if (listDiv.innerHTML !== html) listDiv.innerHTML = html;
    }

    function updateClock() { 
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {hour12:false});
    }
    
    function getTodayStr() { 
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function getMins(t) { 
        if(!t) return 0; 
        t = t.replace('ï¼š', ':');
        const parts = t.split(':');
        if (parts.length < 2) return 0;
        return parseInt(parts[0])*60 + parseInt(parts[1]); 
    }

    function formatTime(m) { let h=Math.floor(m/60), mm=m%60; if(h>=24) h-=24; return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }

    setInterval(updateClock, 1000);
    setInterval(fetchData, 30 * 1000);
    fetchData(); 
</script>
</body>
</html>
